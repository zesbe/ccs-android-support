#!/usr/bin/env bash
set -euo pipefail

# Version - Read from VERSION file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CCS_VERSION="$(cat "$SCRIPT_DIR/VERSION" 2>/dev/null || echo "unknown")"

# --- Color/Format Functions ---
setup_colors() {
  if [[ -t 2 ]] && [[ -z "${NO_COLOR:-}" ]]; then
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    BOLD='\033[1m'
    RESET='\033[0m'
  else
    RED='' YELLOW='' BOLD='' RESET=''
  fi
}

msg_error() {
  echo "" >&2
  echo -e "${RED}${BOLD}╔═════════════════════════════════════════════╗${RESET}" >&2
  echo -e "${RED}${BOLD}║  ERROR                                      ║${RESET}" >&2
  echo -e "${RED}${BOLD}╚═════════════════════════════════════════════╝${RESET}" >&2
  echo "" >&2
  echo -e "${RED}$1${RESET}" >&2
  echo "" >&2
}

setup_colors

CONFIG_FILE="${CCS_CONFIG:-$HOME/.ccs/config.json}"

# Installation function for commands and skills
install_commands_and_skills() {
  local source_dir="$SCRIPT_DIR/.claude"
  local target_dir="$HOME/.claude"

  echo "┌─ Installing CCS Commands & Skills"
  echo "│  Source: $source_dir"
  echo "│  Target: $target_dir"
  echo "│"

  # Check if source directory exists
  if [[ ! -d "$source_dir" ]]; then
    echo "|"
    msg_error "Source directory not found: $source_dir

Make sure you're running this from the CCS repository directory."
    return 1
  fi

  # Create target directories if they don't exist
  mkdir -p "$target_dir/commands"
  mkdir -p "$target_dir/skills"

  local installed_count=0
  local skipped_count=0

  # Install commands
  if [[ -d "$source_dir/commands" ]]; then
    echo "│  Installing commands..."
    for cmd_file in "$source_dir/commands"/*.md; do
      if [[ -f "$cmd_file" ]]; then
        local cmd_name=$(basename "$cmd_file" .md)
        local target_file="$target_dir/commands/$cmd_name.md"

        if [[ -f "$target_file" ]]; then
          echo "|  |  [i]  Skipping existing command: $cmd_name.md"
          skipped_count=$((skipped_count + 1))
        else
          if cp "$cmd_file" "$target_file"; then
            echo "|  |  [OK]  Installed command: $cmd_name.md"
            installed_count=$((installed_count + 1))
          else
            echo "|  |  [X]  Failed to install command: $cmd_name.md"
          fi
        fi
      fi
    done
  else
    echo "|  [i]  No commands directory found"
  fi

  echo "|"

  # Install skills
  if [[ -d "$source_dir/skills" ]]; then
    echo "|  Installing skills..."
    for skill_dir in "$source_dir/skills"/*; do
      if [[ -d "$skill_dir" ]]; then
        local skill_name=$(basename "$skill_dir")
        local target_skill_dir="$target_dir/skills/$skill_name"

        if [[ -d "$target_skill_dir" ]]; then
          echo "|  |  [i]  Skipping existing skill: $skill_name"
          skipped_count=$((skipped_count + 1))
        else
          if cp -r "$skill_dir" "$target_skill_dir"; then
            echo "|  |  [OK]  Installed skill: $skill_name"
            installed_count=$((installed_count + 1))
          else
            echo "|  |  [X]  Failed to install skill: $skill_name"
          fi
        fi
      fi
    done
  else
    echo "|  [i]  No skills directory found"
  fi

  echo "└─"
  echo ""
  echo "[OK] Installation complete!"
  echo "  Installed: $installed_count items"
  echo "  Skipped: $skipped_count items (already exist)"
  echo ""
  echo "You can now use the /ccs command in Claude CLI for task delegation."
  echo "Example: /ccs glm /plan 'add user authentication'"
}

# Special case: version command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "version" || "${1}" == "--version" || "${1}" == "-v" ]]; then
  echo "CCS (Claude Code Switch) version $CCS_VERSION"

  # Show install location if we can determine it
  INSTALL_LOCATION=$(command -v ccs 2>/dev/null || echo "unknown")
  if [[ "$INSTALL_LOCATION" != "unknown" ]]; then
    # Resolve symlink to actual file
    if [[ -L "$INSTALL_LOCATION" ]]; then
      ACTUAL_LOCATION=$(readlink "$INSTALL_LOCATION" 2>/dev/null || echo "$INSTALL_LOCATION")
      echo "Installed at: $INSTALL_LOCATION -> $ACTUAL_LOCATION"
    else
      echo "Installed at: $INSTALL_LOCATION"
    fi
  fi

  echo "https://github.com/kaitranntt/ccs"
  exit 0
fi

# Special case: help command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "--help" || "${1}" == "-h" || "${1}" == "help" ]]; then
  shift  # Remove the help argument
  exec claude --help "$@"
fi

# Special case: install command (check BEFORE profile detection)
if [[ $# -gt 0 ]] && [[ "${1}" == "--install" ]]; then
  install_commands_and_skills
  exit $?
fi

# Smart profile detection: if first arg starts with '-', it's a flag not a profile
if [[ $# -eq 0 ]] || [[ "${1}" =~ ^- ]]; then
  # No args or first arg is a flag → use default profile
  PROFILE="default"
else
  # First arg doesn't start with '-' → treat as profile name
  PROFILE="${1}"
fi

# Check config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
  msg_error "Config file not found: $CONFIG_FILE

Solutions:
  1. Reinstall CCS:
     curl -fsSL ccs.kaitran.ca/install | bash

  2. Or create config manually:
     mkdir -p ~/.ccs
     cat > ~/.ccs/config.json << 'EOF'
{
  \"profiles\": {
    \"glm\": \"~/.ccs/glm.settings.json\",
    \"default\": \"~/.claude/settings.json\"
  }
}
EOF"
  exit 1
fi

# Check jq installed
if ! command -v jq &> /dev/null; then
  msg_error "jq is required but not installed

Install jq:
  macOS:   brew install jq
  Ubuntu:  sudo apt install jq
  Fedora:  sudo dnf install jq"
  exit 1
fi

# Validate profile name (alphanumeric, dash, underscore only)
if [[ "$PROFILE" =~ [^a-zA-Z0-9_-] ]]; then
  msg_error "Invalid profile name: $PROFILE

Use only alphanumeric characters, dash, or underscore."
  exit 1
fi

# Validate JSON syntax
if ! jq -e . "$CONFIG_FILE" &>/dev/null; then
  msg_error "Invalid JSON in $CONFIG_FILE

Fix the JSON syntax or reinstall:
  curl -fsSL ccs.kaitran.ca/install | bash"
  exit 1
fi

# Validate config has profiles object
if ! jq -e '.profiles' "$CONFIG_FILE" &>/dev/null; then
  msg_error "Config must have 'profiles' object

See config/config.example.json for correct format
Or reinstall:
  curl -fsSL ccs.kaitran.ca/install | bash"
  exit 1
fi

# Get settings path for profile (using --arg to prevent injection)
SETTINGS_PATH=$(jq -r --arg profile "$PROFILE" '.profiles[$profile] // empty' "$CONFIG_FILE")

if [[ -z "$SETTINGS_PATH" ]]; then
  AVAILABLE_PROFILES=$(jq -r '.profiles | keys[]' "$CONFIG_FILE" 2>/dev/null | sed 's/^/  - /')
  msg_error "Profile '$PROFILE' not found in $CONFIG_FILE

Available profiles:
$AVAILABLE_PROFILES"
  exit 1
fi

# Expand ~ in path
SETTINGS_PATH="${SETTINGS_PATH/#\~/$HOME}"

# Validate settings file exists
if [[ ! -f "$SETTINGS_PATH" ]]; then
  msg_error "Settings file not found: $SETTINGS_PATH

Solutions:
  1. Create the settings file for profile '$PROFILE'
  2. Update the path in $CONFIG_FILE
  3. Or reinstall: curl -fsSL ccs.kaitran.ca/install | bash"
  exit 1
fi

# Shift profile arg only if first arg was NOT a flag
if [[ $# -gt 0 ]] && [[ ! "${1}" =~ ^- ]]; then
  shift
fi

# Execute claude with settings
exec claude --settings "$SETTINGS_PATH" "$@"
